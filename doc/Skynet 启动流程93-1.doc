<html xmlns:v="urn:schemas-microsoft-com:vml"
xmlns:o="urn:schemas-microsoft-com:office:office"
xmlns:w="urn:schemas-microsoft-com:office:word"
xmlns="http://www.w3.org/TR/REC-html40">
<head>
<meta name="robots" content="noindex,follow">
<meta http-equiv=Content-Type content="text/html; charset=gb2312">
<meta name=ProgId content=Word.Document>
<meta name=Generator content="Microsoft Word 11">
<meta name=Originator content="Microsoft Word 11">
<title>Skynet 启动流程93</title>
<!--[if gte mso 9]><xml>
 <o:DocumentProperties>
  <o:Author>三亿文库</o:Author>
  <o:LastAuthor>三亿文库</o:LastAuthor>
  <o:Revision>1</o:Revision>
  <o:TotalTime>3</o:TotalTime>
  <o:Created>2011-07-03T05:27:00Z</o:Created>
  <o:LastSaved>2015/6/19 15:03:42Z</o:LastSaved>
  <o:Pages>1</o:Pages>
  <o:Words>9</o:Words>
  <o:Company>http://3y.uu456.com</o:Company>
  <o:Paragraphs>1</o:Paragraphs>
  <o:Version>11.9999</o:Version>
 </o:DocumentProperties>
</xml><![endif]--><!--[if gte mso 9]><xml>
 <w:WordDocument>
  <w:View>Print</w:View>
  <w:PunctuationKerning/>
  <w:DrawingGridVerticalSpacing>7.8 磅</w:DrawingGridVerticalSpacing>
  <w:DisplayHorizontalDrawingGridEvery>0</w:DisplayHorizontalDrawingGridEvery>
  <w:DisplayVerticalDrawingGridEvery>2</w:DisplayVerticalDrawingGridEvery>
  <w:ValidateAgainstSchemas/>
  <w:SaveIfXMLInvalid>false</w:SaveIfXMLInvalid>
  <w:IgnoreMixedContent>false</w:IgnoreMixedContent>
  <w:AlwaysShowPlaceholderText>false</w:AlwaysShowPlaceholderText>
  <w:Compatibility>
   <w:SpaceForUL/>
   <w:BalanceSingleByteDoubleByteWidth/>
   <w:DoNotLeaveBackslashAlone/>
   <w:ULTrailSpace/>
   <w:DoNotExpandShiftReturn/>
   <w:AdjustLineHeightInTable/>
   <w:BreakWrappedTables/>
   <w:SnapToGridInCell/>
   <w:WrapTextWithPunct/>
   <w:UseAsianBreakRules/>
   <w:DontGrowAutofit/>
   <w:UseFELayout/>
  </w:Compatibility>
  <w:BrowserLevel>MicrosoftInternetExplorer4</w:BrowserLevel>
 </w:WordDocument>
</xml><![endif]--><!--[if gte mso 9]><xml>
 <w:LatentStyles DefLockedState="false" LatentStyleCount="156">
 </w:LatentStyles>
</xml><![endif]-->
<style>
<!--
 /* Font Definitions */
 @font-face
	{font-family:宋体;
	panose-1:2 1 6 0 3 1 1 1 1 1;
	mso-font-alt:SimSun;
	mso-font-charset:134;
	mso-generic-font-family:auto;
	mso-font-pitch:variable;
	mso-font-signature:3 135135232 16 0 262145 0;}
@font-face
	{font-family:宋体;
	panose-1:2 1 6 9 3 1 1 1 1 1;
	mso-font-charset:134;
	mso-generic-font-family:modern;
	mso-font-pitch:fixed;
	mso-font-signature:1 135135232 16 0 262144 0;}
@font-face
	{font-family:"\@宋体";
	panose-1:2 1 6 0 3 1 1 1 1 1;
	mso-font-charset:134;
	mso-generic-font-family:auto;
	mso-font-pitch:variable;
	mso-font-signature:3 135135232 16 0 262145 0;}
@font-face
	{font-family:"\@仿宋_GB2312";
	panose-1:2 1 6 9 3 1 1 1 1 1;
	mso-font-charset:134;
	mso-generic-font-family:modern;
	mso-font-pitch:fixed;
	mso-font-signature:1 135135232 16 0 262144 0;}
 /* Style Definitions */
 p.MsoNormal, li.MsoNormal, div.MsoNormal
	{mso-style-parent:"";
	margin:0cm;
	margin-bottom:.0001pt;
	text-align:justify;
	text-justify:inter-ideograph;
	mso-pagination:none;
	font-size:13.0pt;
	mso-bidi-font-size:10.0pt;
	font-family:"Times New Roman";
	mso-fareast-font-family:宋体;
	mso-font-kerning:1.0pt;}
h1
	{mso-style-next:正文;
	margin-top:17.0pt;
	margin-right:0cm;
	margin-bottom:16.5pt;
	margin-left:0cm;
	text-align:justify;
	text-justify:inter-ideograph;
	line-height:140%;
	mso-pagination:lines-together;
	page-break-after:avoid;
	mso-outline-level:1;
	font-size:18.0pt;
	font-family:"Times New Roman";
	mso-font-kerning:18.0pt;}
 /* Page Definitions */
 @page
	{mso-page-border-surround-header:no;
	mso-page-border-surround-footer:no;}
@page Section1
	{size:595.3pt 841.9pt;
	margin:72.0pt 90.0pt 72.0pt 90.0pt;
	mso-header-margin:42.55pt;
	mso-footer-margin:49.6pt;
	mso-paper-source:0;
	layout-grid:15.6pt;}
div.Section1
	{page:Section1;}
-->
</style>
<!--[if gte mso 10]>
<style>
 /* Style Definitions */
 table.MsoNormalTable
	{mso-style-name:普通表格;
	mso-tstyle-rowband-size:0;
	mso-tstyle-colband-size:0;
	mso-style-noshow:yes;
	mso-style-parent:"";
	mso-padding-alt:0cm 5.4pt 0cm 5.4pt;
	mso-para-margin:0cm;
	mso-para-margin-bottom:.0001pt;
	mso-pagination:widow-orphan;
	font-size:10.0pt;
	font-family:"Times New Roman";
	mso-ansi-language:#0400;
	mso-fareast-language:#0400;
	mso-bidi-language:#0400;}
</style>
<![endif]--><!--[if gte mso 9]><xml>
 <o:shapelayout v:ext="edit">
  <o:idmap v:ext="edit" data="1"/>
 </o:shapelayout></xml><![endif]-->
</head>
<body lang=ZH-CN style='tab-interval:21.0pt;text-justify-trim:punctuation'>
<div class=Section1 style='layout-grid:14pt'>


<p class=MsoNormal align=left style='text-align:left;line-height:150%;margin-top:3.6pt;'><span lang=EN-US style='font-size:9.0pt;line-height:150%'><a href="http://3y.uu456.com/ss_02b02z03d03202t03800wgmngbslkxo3v01l01f_1.html"><span lang=EN-US style='font-family:宋体;mso-ascii-font-family:"Times New Roman";mso-hansi-font-family:"Times New Roman";text-decoration:none;text-underline:none'><span lang=EN-US>点这里，有很多篇《Skynet 启动流程93》</span></span></a><o:p></o:p></span></p>

<p class=MsoNormal align=left style='text-align:left'><span style='font-size:12.0pt;font-family:宋体;mso-ascii-font-family:"Times New Roman";mso-hansi-font-family:"Times New Roman";color:#993300'>在线阅读本文：</span><span lang=EN-US style='font-size:12.0pt;color:#999999'><a href="http://3y.uu456.com/bp_8k2ly5skkc9sc9k3qcyg_1.html"><span
style='text-decoration:none;text-underline:none'>http://3y.uu456.com/bp_8k2ly5skkc9sc9k3qcyg_1.html</span></a><o:p></o:p></span></p>

<h1 align=center style='text-align:center'><span style='font-family:宋体;mso-ascii-font-family:"Times New Roman";mso-hansi-font-family:"Times New Roman"'>Skynet 启动流程93</span></h1>


<div class=MsoNormal style='margin-top:7.8pt;margin-right:0cm;margin-bottom:7.8pt;
margin-left:0cm;mso-para-margin-top:.5gd;mso-para-margin-right:0cm;mso-para-margin-bottom:
.5gd;mso-para-margin-left:0cm;text-indent:2em;mso-char-indent-count:2.0;
line-height:20pt;mso-line-height-rule:exactly;font-family:宋体;
mso-hansi-font-family:宋体;'><p>Skynet 启动流程</p><p>wangdali &lt;wangdali@qq.com&gt;</p><p> </p><p>启动流程的相关源代码在 skynet-src\skynet_main.c 和 skynet-src\skynet_start.c 这两个文件中。</p><p>skynet_main.c 主要是设置环境和加载配置文件，最后调用 skynet_start.c 文件中的 skynet_start() 函数启动 Skynet 服务程序。 skynet_start.c 主要是初始化Skynet 的各个组件，并创建监视线程、定时器线程、网络线程和工作线程。</p><p>一、skynet_main.c 的流程如下：</p><p>1、 从main()入口函数开始。</p><p>2、 skynet_globalinit() 全局初始化，这个函数在skynet_server.c中定义，主要功能是为线程特有数据创建一个Key。使用pthread_key_create()函数。并使用pthread_setspecific()函数设置特有数据Key的Value值。</p><p>3、 skynet_env_init()为初始化Lua的环境，这个函数在skynet_env.c中定义，主要创建一个全局的数据结构struct skynet_env *E，并初始化结构的值。</p><p>4、 sigign()为信号处理，主要是用于忽略SIGPIPE信号的处理。</p><p>5、 从步骤5到步骤11主要是在Lua状态机中运行，lua_newstate(skynet_lalloc, NULL)表示，新建一个Lua状态机，并使用skynet_lalloc()内存分配机制，这个定义在</p><p>malloc_hook.c中。</p><p>6、 luaL_openlibs() 打开Lua的标准库。</p><p>7、 luaL_loadstring(L, load_config) 用于加载一段Lua脚本字符</p><p>串，这个lua脚本主要用于打开名字为config_file的lua脚本用作skynet的配置文件。</p><p>8、 lua_pushstring(L, config_file)主要是压入上面加载的Lua脚</p><p>本字符串的参数config_file，这个参数将由main()函数的argv[1]参数定义。</p><p>9、 lua_pcall(L, 1, 1, 0) 执行加载的Lua脚本字符串，这将会加</p><p>载config_file定义的lua脚本用于Skynet的配置。</p><p>10、 _init_env() 弹出Skynet配置脚本的Key和Value，并设置为</p><p>Lua环境变量，最后设置对应Key的值到struct skynet_config config结构中，方便skynet_start()调用时传入配置文件的参数。</p><p>11、 lua_close(L) 关闭上面用lua_newstate()创建的Lua状态机。</p><p>12、 skynet_start()传人配置参数并启动Skynet的各个组件和线</p><p>程。这个函数定义在skynet_start.c文件中。</p><p>13、 skynet_globalexit()对应上面的skynet_globalinit()，用于删除</p><p>线程存储的Key。</p><p> </p><p>下图为skynet_main.c的整个执行流程：主要的功能也就是加载lua脚本编写的配置文件，并设置struct skynet_config config</p><p>结构，最后调用skynet_start()执行启动过程。</p><p> </p><p>二、skynet_start.c的流程如下：</p><p>1、skynet_start()启动函数，由main()函数调用。</p><p>2、daemon_init()初始化守护进程，由配置文件确定是否启用。这个函数定义在skynet_daemon.c中。</p><p>3、skynet_harbor_init()初始化节点模块，用于集群，转发远程节点的消息。这个函数定义在skynet_harbor.c中。</p><p>4、skynet_handle_init()初始化句柄模块，用于给每个Skynet</p><p>服务</p><p>创建一个全局唯一的句柄值。这个函数定义在skynet_handle.c中。</p><p>5、skynet_mq_init()初始化消息队列模块，这是Skynet的主要数据结构。这个函数定义在skynet_mq.c中。</p><p>6、skynet_module_init()初始化服务动态库加载模块，主要用于加载符合Skynet服务模块接口的动态链接库。这个函数定义在skynet_module.c中。</p><p>7、skynet_timer_init()初始化定时器模块。这个函数定义在skynet_timer.c中。</p><p>8、skynet_socket_init()初始化网络模块。这个函数定义在skynet_socket.c中。</p><p>9、skynet_context_new(logger)加载日志模块。这个函数定义在skynet_server.c中。</p><p>10、bootstrap()加载引导模块。主要在Skynet配置文件中定义，默认定义为bootstrap = &quot;snlua bootstrap&quot;，表示引导程序将加载snlua.so模块，并由snlua服务启动bootstrap.lua脚本。如果不使用snlua也可以直接启动其它服务的动态库。</p><p>11、_start()函数中创建_monitor()监视线程，用create_thread()创建，create_thread()封装了系统函数pthread_create()。</p><p>12、_start()函数中创建_timer()定时器线程。</p><p>13、_start()函数中创建_socket()网络线程。</p><p>14、_start()函数中创建_worker()工作线程。工作线程的数量由Skynet配置文件中的thread = 8定义。一般根据服务器的CPU核数来</p><p>设置。</p><p>15、skynet_socket_free()释放网络模块。</p><p>16、daemon_exit()退出守护进程。这个根据Skynet配置文件的需要，决定是否启用。</p><p> </p><p>下图为skynet_start.c的整个执行流程：主要功能就是初始化Skynet的各个组件模块，然后启动监视线程、定时器线程、网络线程和工作线程。</p><p> </p><p><a href=http://3y.uu456.com>三亿文库3y.uu456.com</a>包含各类专业文献、文学作品欣赏、高等教育、专业论文、生活休闲娱乐、外语学习资料、Skynet 启动流程93等内容。</p></div>

<p class=MsoFooter align=center style='text-align:center'><span
style='font-family:宋体;mso-ascii-font-family:"Times New Roman";mso-hansi-font-family:"Times New Roman";color:#993300'>三亿文库</span><span lang=EN-US><a
href="http://3y.uu456.com/">http://3y.uu456.com/</a></span></p>

<p class=MsoFooter align=center style='text-align:center'><span
style='font-family:宋体;mso-ascii-font-family:"Times New Roman";mso-hansi-font-family:"Times New Roman";color:#993300'>上亿文档资料，等你来发现</span><span lang=EN-US style='font-size:16.0pt;mso-bidi-font-size:10.0pt;color:#993300'><o:p></o:p></span></p>
</div>
</body></html>